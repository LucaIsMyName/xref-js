!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Xref=e()}(this,(function(){"use strict";class t{constructor(t,e){this.cache=new Map,this.options=t,this.xrefOptions=e,this.init()}init(){this.options.active&&document.addEventListener(this.options.event||"mouseover",this.handleEvent.bind(this))}handleEvent(t){const e=t.target.closest(this.options.selector||"a");e&&this.shouldPrefetch(e)&&setTimeout((()=>this.prefetch(e.href)),this.options.delay||100)}shouldPrefetch(t){return!(!t.href||!t.href.startsWith(window.location.origin)||t.href===window.location.href||this.cache.has(t.href))}async prefetch(t){try{const e=await fetch(t),n=await e.text();this.cache.set(t,n),this.xrefOptions.debug&&console.log(`Prefetched: ${t}`)}catch(e){this.xrefOptions.debug&&console.error("Failed to prefetch:"+t,e)}}getContent(t){return this.cache.get(t)||null}}function e(t){return t.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}async function n(t,e,n,i,s){i.debug&&console.log(`Handling partials for ${s} transition`);const a=t.flatMap((t=>{const n=e.querySelectorAll(t.element);return i.debug&&console.log(`Found ${n.length} elements matching selector: ${t.element}`),Array.from(n).map((e=>"out"===s&&t.out?o(e,t.out,i,"out"):"in"===s&&t.in?o(e,t.in,i,"in"):Promise.resolve()))}));await Promise.all(a)}async function o(t,n,o,i){return new Promise((s=>{const a=o.transition,r=a.duration||300,l=a.delay||0,c=a.easing||"ease-in-out";o.debug&&console.log(`Applying ${i} transition to partial: ${t.tagName}`);const d=function(t,n){const{from:o,to:i}=t,s=`xref-partial-${n}-${Math.random().toString(36).substr(2,9)}`,a=`@keyframes ${s} {\n    from {\n      ${Object.entries(o||{}).map((([t,n])=>`${e(t)}: ${n};`)).join(" ")}\n    }\n    to {\n      ${Object.entries(i||{}).map((([t,n])=>`${e(t)}: ${n};`)).join(" ")}\n    }\n  }`,r=document.createElement("style");return r.textContent=a,document.head.appendChild(r),s}(n,i),h=`${d} ${r/2}ms ${c} ${l}ms forwards`;t.style.setProperty("animation",h),o.debug&&console.log(`Applied ${i} animation to partial: ${h}`),o.debug&&console.log("Current partial element style:",t.style.cssText),t.offsetWidth;t.addEventListener("animationend",(()=>{o.debug&&console.log(`Animation end event fired for ${i} transition on partial: ${t.tagName}`),t.style.removeProperty("animation"),function(){const t=document.querySelector('style:not([data-xref="true"]):last-of-type');t&&t.remove()}(),"in"===i&&Object.entries(n.to||{}).forEach((([n,o])=>{t.style.setProperty(e(n),o)})),o.debug&&console.log(`Cleaned up ${i} animation for partial: ${t.tagName}`),o.debug&&console.log("Current partial element style after cleanup:",t.style.cssText),s()}),{once:!0})}))}class i{constructor(t={}){var e;this.transitionCounter=0,this.prefetcher=null,this.currentKeyframeName=null,this.options=Object.assign({updateHead:!0},t),this.styleElement=document.createElement("style"),this.styleElement.setAttribute("data-xref","true"),document.head.appendChild(this.styleElement),this.animationState=Object.assign({started:!1,playing:!0,paused:!1,finished:!1},null===(e=this.options.transition)||void 0===e?void 0:e.state),this.init()}init(){var e,n;this.options.debug&&console.log("started -> init() Method"),this.interceptClicks(),this.handlePopState(),this.options.prefetch&&this.options.prefetch.active&&(this.prefetcher=(e=this.options.prefetch,n=this.options,new t(e,n)))}createKeyframes(t,n){const{from:o,to:i}=t,s=`xref-${n}-${++this.transitionCounter}`;let a=`@keyframes ${s} {\n      from {\n        ${Object.entries(o||{}).map((([t,n])=>`${e(t)}: ${n};`)).join(" ")}\n      }\n      to {\n        ${Object.entries(i||{}).map((([t,n])=>`${e(t)}: ${n};`)).join(" ")}\n      }\n    }`;return this.options.debug&&console.log("Creating keyframe:"+s),this.options.debug&&console.log("Keyframe CSS:"+a),this.currentKeyframeName&&this.removeKeyframes(this.currentKeyframeName),this.styleElement.textContent=a,this.currentKeyframeName=s,this.options.debug&&console.log("Keyframe "+s+"appended to <style> element"),this.options.debug&&console.log("Current <style> content: "+this.styleElement.textContent),s}removeKeyframes(t){this.options.debug&&console.log("Removing keyframe: "+t),this.styleElement.textContent="",this.options.debug&&console.log("Keyframe"+t+"removed"),this.options.debug&&console.log("Current <style> content after removal:"+this.styleElement.textContent),this.currentKeyframeName=null}interceptClicks(){this.options.debug&&console.log("started -> interceptClicks() Method"),document.addEventListener("click",(t=>{const e=t.target.closest("a");e&&this.shouldIntercept(e)&&(t.preventDefault(),this.runCallback("onEnter"),this.navigate(e.href))}))}shouldIntercept(t){this.options.debug&&console.log("started -> shouldIntercept() Method");const e=new URL(window.location.href),n=new URL(t.href),o=n.origin===e.origin,i=n.pathname===e.pathname&&n.search===e.search,s=i&&n.hash!==e.hash;return o&&!i&&!s}handlePopState(){this.options.debug&&console.log("started -> handlePopState() Method"),window.addEventListener("popstate",(()=>{this.navigate(window.location.href,!1)}))}async navigate(t,e=!0){this.options.debug&&console.log("started -> navigate() Method");try{let n=null;this.prefetcher&&(n=this.prefetcher.getContent(t)),n||(n=await this.fetchPage(t)),n&&(e&&history.pushState(null,"",t),this.updatePage(n))}catch(t){this.options.debug&&console.error("Navigation failed:",t)}}async fetchPage(t){this.options.debug&&console.log("started -> fetchPage() Method");const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.text()}async updatePage(t){this.options.debug&&console.log("started -> updatePage() Method");const e=(new DOMParser).parseFromString(t,"text/html");await this.updateBody(e),this.updateHead(e)}updateHead(t){var e;this.options.debug&&console.log("started -> updateHead() Method");const n=document.head,o=t.head;document.title=t.title,!1!==(null===(e=this.options.head)||void 0===e?void 0:e.update)&&(Array.from(n.children).forEach((t=>{t!==this.styleElement&&"TITLE"!==t.tagName&&t.remove()})),Array.from(o.children).forEach((t=>{if("STYLE"!==t.tagName&&"TITLE"!==t.tagName){const e=t.cloneNode(!0);n.appendChild(e),this.retriggerElement(e)}})),this.options.debug&&console.log("Head updated, xref style element preserved"))}retriggerElement(t){var e;const{retrigger:n}=this.options.head||{};if(!n)return;const o=t=>!(n.include&&!t.matches(n.include.toString()))&&(!n.exclude||!t.matches(n.exclude.toString()));if("LINK"===t.tagName&&n.css&&o(t)){const e=t;e.href=e.href.split("?")[0]+"?t="+(new Date).getTime()}else if("SCRIPT"===t.tagName&&n.js&&o(t)){const n=t,o=document.createElement("script");Array.from(n.attributes).forEach((t=>o.setAttribute(t.name,t.value))),o.textContent=n.textContent,null===(e=n.parentNode)||void 0===e||e.replaceChild(o,n)}}async updateBody(t){var e;this.options.debug&&console.log("started -> updateBody() Method");const n=(null===(e=this.options.transition)||void 0===e?void 0:e.swapHtml)||"body",o=document.querySelector(n),i=t.querySelector(n);o&&i?(await this.performTransition(o,i),window.scrollTo(0,0)):this.options.debug&&console.error(`Element not found: ${n}`)}async performTransition(t,e){this.options.debug&&console.log("Started performTransition");const o=this.options.transition||{},i=o.duration||300,s=o.delay||0,a=o.easing||"ease-in-out";let r=o.out,l=o.in;this.setTransitionState("started",!0),this.runCallback("onStart");const c=this.getPartialsOutsideSwapHtml();var d,h;c.length>0&&(this.options.debug&&console.log("Applying partial out transitions"),await n(c,document.body,document.body,this.options,"out")),c.length>0&&(d=c,h=document.body,d.forEach((t=>{h.querySelectorAll(t.element).forEach((t=>{t.style.visibility="hidden"}))}))),r&&(this.options.debug&&console.log("Applying main out transition"),await this.applyTransition(t,r,i/2,s,a,"out")),t.innerHTML=e.innerHTML,Array.from(e.attributes).forEach((e=>{"style"!==e.name&&t.setAttribute(e.name,e.value)})),l&&(this.options.debug&&console.log("Applying main in transition"),await this.applyTransition(t,l,i/2,0,a,"in")),c.length>0&&function(t,e){t.forEach((t=>{e.querySelectorAll(t.element).forEach((t=>{t.style.visibility="visible"}))}))}(c,document.body),c.length>0&&(this.options.debug&&console.log("Applying partial in transitions"),await n(c,document.body,document.body,this.options,"in")),this.setTransitionState("finished",!0),this.runCallback("onFinish"),window.scrollTo(0,0)}getPartialsOutsideSwapHtml(){var t,e;const n=(null===(t=this.options.transition)||void 0===t?void 0:t.swapHtml)||"body",o=document.querySelector(n);return((null===(e=this.options.transition)||void 0===e?void 0:e.partials)||[]).filter((t=>{const e=document.querySelectorAll(t.element);return Array.from(e).every((t=>!(null==o?void 0:o.contains(t))))}))}reverseTransition(t){return{from:t.to,to:t.from}}applyTransition(t,n,o,i,s,a){return new Promise((r=>{this.options.debug&&console.log(`Applying ${a} transition`);const l=this.createKeyframes(n,a),c=`${l} ${o}ms ${s} ${i}ms forwards`;t.style.setProperty("animation",c),this.options.debug&&console.log(`Applied ${a} animation: ${c}`),this.options.debug&&console.log("Current element style:",t.style.cssText),t.offsetWidth;t.addEventListener("animationend",(()=>{this.options.debug&&console.log(`Animation end event fired for ${a} transition`),t.style.removeProperty("animation"),this.removeKeyframes(l),"in"===a&&Object.entries(n.to||{}).forEach((([n,o])=>{t.style.setProperty(e(n),o)})),this.options.debug&&console.log(`Cleaned up ${a} animation`),this.options.debug&&console.log("Current element style after cleanup:",t.style.cssText),r()}),{once:!0})}))}setTransitionState(t,e){this.animationState[t]=e}runCallback(t){var e,n;const o=null===(n=null===(e=this.options.transition)||void 0===e?void 0:e.callback)||void 0===n?void 0:n[t];o&&"function"==typeof o&&o()}startTransition(){this.setTransitionState("started",!0),this.setTransitionState("playing",!0),this.setTransitionState("paused",!1),this.setTransitionState("finished",!1),this.runCallback("onStart"),this.runCallback("onPlay")}pauseTransition(){var t;if(this.animationState.playing){this.setTransitionState("playing",!1),this.setTransitionState("paused",!0),this.runCallback("onPause");const e=document.querySelector((null===(t=this.options.transition)||void 0===t?void 0:t.swapHtml)||"body");e instanceof HTMLElement&&(e.style.animationPlayState="paused")}}resumeTransition(){var t;if(this.animationState.paused){this.setTransitionState("playing",!0),this.setTransitionState("paused",!1),this.runCallback("onPlay");const e=document.querySelector((null===(t=this.options.transition)||void 0===t?void 0:t.swapHtml)||"body");e instanceof HTMLElement&&(e.style.animationPlayState="running")}}finishTransition(){this.setTransitionState("playing",!1),this.setTransitionState("paused",!1),this.setTransitionState("finished",!0),this.runCallback("onFinish")}}return function(t={}){return new i(t)}}));
//# sourceMappingURL=xref.umd.min.js.map
