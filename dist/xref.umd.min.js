!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Xref=e()}(this,(function(){"use strict";class t{constructor(t,e){this.cache=new Map,this.options=t,this.xrefOptions=e,this.init()}init(){this.options.active&&document.addEventListener(this.options.event||"mouseover",this.handleEvent.bind(this))}handleEvent(t){const e=t.target.closest(this.options.selector||"a");e&&this.shouldPrefetch(e)&&setTimeout((()=>this.prefetch(e.href)),this.options.delay||100)}shouldPrefetch(t){return!(!t.href||!t.href.startsWith(window.location.origin)||t.href===window.location.href||this.cache.has(t.href))}async prefetch(t){try{const e=await fetch(t),o=await e.text();this.cache.set(t,o),this.xrefOptions.debug&&console.log(`Prefetched HTML: ${t}`);const n=(new DOMParser).parseFromString(o,"text/html");this.options.media&&await this.prefetchMedia(n),this.options.css&&await this.prefetchCss(n),this.options.js&&await this.prefetchJs(n)}catch(e){this.xrefOptions.debug&&console.error("Failed to prefetch:"+t,e)}}async prefetchMedia(t){const e=t.querySelectorAll("img, video, audio"),o=Array.from(e).map((async t=>{const e=t.src;if(e&&!this.cache.has(e)&&!this.isCurrentlyLoaded(e))try{await this.prefetchResource(e)}catch(t){this.xrefOptions.debug&&console.error(`Failed to prefetch media: ${e}`,t)}}));await Promise.all(o)}async prefetchCss(t){const e=t.querySelectorAll("link[rel=stylesheet]"),o=Array.from(e).map((async t=>{const e=t.href;if(e&&!this.cache.has(e)&&!this.isCurrentlyLoaded(e))try{await this.prefetchResource(e)}catch(t){this.xrefOptions.debug&&console.error(`Failed to prefetch CSS: ${e}`,t)}}));await Promise.all(o)}async prefetchJs(t){const e=t.querySelectorAll("script"),o=Array.from(e).map((async t=>{const e=t.src;if(e&&!this.cache.has(e)&&!this.isCurrentlyLoaded(e))try{await this.prefetchResource(e)}catch(t){this.xrefOptions.debug&&console.error(`Failed to prefetch JS: ${e}`,t)}}));await Promise.all(o)}async prefetchResource(t){try{const e=await fetch(t),o=await e.blob();this.cache.set(t,URL.createObjectURL(o)),this.xrefOptions.debug&&console.log(`Prefetched resource: ${t}`)}catch(t){throw t}}isCurrentlyLoaded(t){const e=document.querySelectorAll("script"),o=document.querySelectorAll("link"),n=document.querySelectorAll("img"),i=document.querySelectorAll("audio"),s=document.querySelectorAll("video");return Array.from(e).some((e=>e.src===t))||Array.from(o).some((e=>e.href===t))||Array.from(n).some((e=>e.src===t))||Array.from(i).some((e=>e.src===t))||Array.from(s).some((e=>e.src===t))}getContent(t){return this.cache.get(t)||null}}function e(t){return t.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}async function o(t,o,n,i,s){i.debug&&console.log(`Handling partials for ${s} transition`);const r=t.flatMap(((t,n)=>{const r=o.querySelectorAll(t.element);return i.debug&&console.log(`Found ${r.length} elements matching selector: ${t.element}`),Array.from(r).map((o=>{const r=function(t,e,o){var n,i,s,r;const a=(null===(n=null==e?void 0:e.partials)||void 0===n?void 0:n[o])||{};return Object.assign(Object.assign(Object.assign({},e),a),{duration:null!==(i=t.duration)&&void 0!==i?i:null==e?void 0:e.duration,delay:null!==(s=t.delay)&&void 0!==s?s:null==e?void 0:e.delay,easing:null!==(r=t.easing)&&void 0!==r?r:null==e?void 0:e.easing})}(t,i.transition,n);let a="out"===s?t.out:t.in;if(!a){const e="out"===s?t.in:t.out;e&&(a={from:(l=e).to,to:l.from})}var l;return a?("in"===s&&o.style.removeProperty("visibility"),async function(t,o,n,i){return new Promise((s=>{var r;const a=n.duration||300,l=null!==(r=n.delay)&&void 0!==r?r:0,c=n.easing||"ease-in-out",d=function(t,o){const{from:n,to:i}=t;let s=Math.random().toString(36).substr(2,9);const r=`xref-partial-${o}-${s}`,a=`@keyframes ${r} {\n    from {\n      ${Object.entries(n||{}).map((([t,o])=>`${e(t)}: ${o};`)).join(" ")}\n    }\n    to {\n      ${Object.entries(i||{}).map((([t,o])=>`${e(t)}: ${o};`)).join(" ")}\n    }\n  }`,l=document.createElement("style");return l.textContent=a,l.setAttribute(r,""),document.head.appendChild(l),r}(o,i),h=`${d} ${a}ms ${c} ${l}ms forwards`;t.style.setProperty("animation",h),console.log(`Applied ${i} animation to partial: ${h}`),console.log("Current partial element style:",t.style.cssText),t.offsetWidth;const u=()=>{console.log(`Animation end event fired for ${i} transition on partial: ${t.tagName}`),t.style.removeProperty("animation"),function(t){const e=document.querySelector(`style[${t}]`);e&&e.remove()}(d),"in"===i&&Object.entries(o.to||{}).forEach((([o,n])=>{t.style.setProperty(e(o),n)})),console.log(`Cleaned up ${i} animation for partial: ${t.tagName}`),console.log("Current partial element style after cleanup:",t.style.cssText),s()};t.addEventListener("animationend",u,{once:!0})}))}(o,a,r,s)):Promise.resolve()}))}));await Promise.all(r)}function n(t,e){t.forEach((t=>{e.querySelectorAll(t.element).forEach((t=>{t.style.visibility="hidden"}))}))}class i{constructor(t={}){var e;this.transitionCounter=0,this.prefetcher=null,this.currentKeyframeName=null,this.options=Object.assign({updateHead:!0,prefetch:{active:!1,delay:0,event:"mouseover",media:!1,css:!1,js:!1}},t),this.styleElement=document.createElement("style"),this.styleElement.setAttribute("data-xref","true"),document.head.appendChild(this.styleElement),this.animationState=Object.assign({started:!1,playing:!0,paused:!1,finished:!1},null===(e=this.options.transition)||void 0===e?void 0:e.state),this.init()}init(){var e,o;this.options.debug&&console.log("started -> init() Method"),this.interceptClicks(),this.handlePopState(),this.options.prefetch&&this.options.prefetch.active&&(this.prefetcher=(e=this.options.prefetch,o=this.options,new t(e,o)))}createKeyframes(t,o){const{from:n,to:i}=t,s=`xref-${o}-${++this.transitionCounter}`;let r=`@keyframes ${s} {\n      from {\n        ${Object.entries(n||{}).map((([t,o])=>`${e(t)}: ${o};`)).join(" ")}\n      }\n      to {\n        ${Object.entries(i||{}).map((([t,o])=>`${e(t)}: ${o};`)).join(" ")}\n      }\n    }`;return this.options.debug&&console.log("Creating keyframe:"+s),this.options.debug&&console.log("Keyframe CSS:"+r),this.currentKeyframeName&&this.removeKeyframes(this.currentKeyframeName),this.styleElement.textContent=r,this.currentKeyframeName=s,this.options.debug&&console.log("Keyframe "+s+"appended to <style> element"),this.options.debug&&console.log("Current <style> content: "+this.styleElement.textContent),s}removeKeyframes(t){this.options.debug&&console.log("Removing keyframe: "+t),this.styleElement.textContent="",this.options.debug&&console.log("Keyframe"+t+"removed"),this.options.debug&&console.log("Current <style> content after removal:"+this.styleElement.textContent),this.currentKeyframeName=null}interceptClicks(){this.options.debug&&console.log("started -> interceptClicks() Method"),document.addEventListener("click",(t=>{const e=t.target.closest("a");e&&this.shouldIntercept(e)&&(t.preventDefault(),this.runCallback("onEnter"),this.navigate(e.href))}))}shouldIntercept(t){this.options.debug&&console.log("started -> shouldIntercept() Method");const e=new URL(window.location.href),o=new URL(t.href),n=o.origin===e.origin,i=o.pathname===e.pathname&&o.search===e.search,s=i&&o.hash!==e.hash;return n&&!i&&!s}handlePopState(){this.options.debug&&console.log("started -> handlePopState() Method"),window.addEventListener("popstate",(()=>{this.navigate(window.location.href,!1)}))}async navigate(t,e=!0){this.options.debug&&console.log("started -> navigate() Method");try{let o=null;this.prefetcher&&(o=this.prefetcher.getContent(t)),o||(o=await this.fetchPage(t)),o&&(e&&history.pushState(null,"",t),this.updatePage(o))}catch(t){this.options.debug&&console.error("Navigation failed:",t)}}async fetchPage(t){this.options.debug&&console.log("started -> fetchPage() Method");const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.text()}async updatePage(t){this.options.debug&&console.log("started -> updatePage() Method");const e=(new DOMParser).parseFromString(t,"text/html");await this.updateBody(e),this.updateHead(e),this.handleScripts(document,e);const o=new CustomEvent("xrefPageUpdated");document.dispatchEvent(o),window.scrollTo(0,0)}updateStyles(t,e){const o=Array.from(t.querySelectorAll('style:not([data-xref="true"])')),n=Array.from(e.querySelectorAll("style"));o.forEach((t=>t.remove())),n.forEach((t=>{const e=document.createElement("style");e.textContent=t.textContent,Array.from(t.attributes).forEach((t=>{e.setAttribute(t.name,t.value)})),document.head.appendChild(e)}))}updateHead(t){var e;this.options.debug&&console.log("started -> updateHead() Method");const o=document.head,n=t.head;document.title=t.title,!1!==(null===(e=this.options.head)||void 0===e?void 0:e.update)&&(Array.from(o.children).forEach((t=>{t!==this.styleElement&&"TITLE"!==t.tagName&&t.remove()})),Array.from(n.children).forEach((t=>{if("TITLE"!==t.tagName){const e=t.cloneNode(!0);o.appendChild(e),this.retriggerElement(e)}})),this.options.debug&&console.log("Head updated, xref style element preserved"))}retriggerElement(t){var e;const{retrigger:o}=this.options.head||{};if(!o)return;const n=t=>!(o.include&&!t.matches(o.include.toString()))&&(!o.exclude||!t.matches(o.exclude.toString()));if("LINK"===t.tagName&&o.css&&n(t)){const e=t;e.href=e.href.split("?")[0]+"?t="+(new Date).getTime()}else if("SCRIPT"===t.tagName&&o.js&&n(t)){const o=t,n=document.createElement("script");Array.from(o.attributes).forEach((t=>n.setAttribute(t.name,t.value))),n.textContent=o.textContent,null===(e=o.parentNode)||void 0===e||e.replaceChild(n,o)}}async updateBody(t){var e;this.options.debug&&console.log("started -> updateBody() Method");const o=(null===(e=this.options.transition)||void 0===e?void 0:e.swapHtml)||"body",n=document.querySelector(o),i=t.querySelector(o);n&&i?(await this.performTransition(n,i),n.innerHTML=i.innerHTML,Array.from(i.attributes).forEach((t=>{"style"!==t.name&&n.setAttribute(t.name,t.value)}))):this.options.debug&&console.error(`Element not found: ${o}`)}handleScripts(t,e){const o=(t,e)=>{const o=Array.from(t.querySelectorAll("script")),n=Array.from(e.querySelectorAll("script"));o.forEach((t=>{n.find((e=>e.src===t.src&&e.textContent===t.textContent))||t.remove()})),n.forEach((e=>{var n,i;const s=o.find((t=>t.src===e.src&&t.textContent==t.textContent));if(s)if(e.src){const t=document.createElement("script");Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),null===(i=s.parentNode)||void 0===i||i.replaceChild(t,s)}else{const t=document.createElement("script");Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.textContent=e.textContent,null===(n=s.parentNode)||void 0===n||n.replaceChild(t,s)}else{const o=document.createElement("script");Array.from(e.attributes).forEach((t=>o.setAttribute(t.name,t.value))),o.textContent=e.textContent,t.appendChild(o)}let r=document.querySelectorAll("style"),a=Array.from(r),l=a.map((t=>t.textContent)),c=new Set(l),d=Array.from(c);a.forEach((t=>{let e=t.textContent;d.indexOf(e)>0&&t.remove()}))}))};o(t.head,e.head),o(t.body,e.body)}async performTransition(t,e){var i,s,r,a,l,c;this.options.debug&&console.log("Started performTransition");const d=this.options.transition||{},h=d.duration||300,u=d.delay||0,m=d.easing||"ease-in-out";let p=d.out,f=d.in;this.setTransitionState("started",!0),this.runCallback("onStart");const y=this.getPartialsOutsideSwapHtml(),g=(y.length>0?h:0)+(p?h:0)+(f?h:0)+(y.length>0?h:0);let v=0;if(y.length>0){this.options.debug&&console.log("Applying partial out transitions");const t=o(y,document.body,document.body,this.options,"out");await t,v+=h,n(y,document.body)}if(p&&(this.options.debug&&console.log("Applying main out transition"),await this.applyTransition(t,p,h,u,m,"out"),v+=h),v>=g/2&&(null===(i=this.options.head)||void 0===i?void 0:i.update)&&(null===(r=null===(s=this.options.head)||void 0===s?void 0:s.retrigger)||void 0===r?void 0:r.css)){const t=(new DOMParser).parseFromString(e.ownerDocument.documentElement.outerHTML,"text/html");this.updateStyles(document,t)}if(t.innerHTML=e.innerHTML,Array.from(e.attributes).forEach((e=>{"style"!==e.name&&t.setAttribute(e.name,e.value)})),v<g/2){const t=g/2-v;if(await new Promise((e=>setTimeout(e,t))),(null===(a=this.options.head)||void 0===a?void 0:a.update)&&(null===(c=null===(l=this.options.head)||void 0===l?void 0:l.retrigger)||void 0===c?void 0:c.css)){const t=(new DOMParser).parseFromString(e.ownerDocument.documentElement.outerHTML,"text/html");this.updateStyles(document,t)}}f&&(this.options.debug&&console.log("Applying main in transition"),await this.applyTransition(t,f,h,u,m,"in")),y.length>0&&(n(y,document.body),await o(y,document.body,document.body,this.options,"in")),this.setTransitionState("finished",!0),this.runCallback("onFinish"),window.scrollTo(0,0)}getPartialsOutsideSwapHtml(){var t,e;const o=(null===(t=this.options.transition)||void 0===t?void 0:t.swapHtml)||"body",n=document.querySelector(o);return((null===(e=this.options.transition)||void 0===e?void 0:e.partials)||[]).filter((t=>{const e=document.querySelectorAll(t.element);return Array.from(e).every((t=>!(null==n?void 0:n.contains(t))))}))}reverseTransition(t){return{from:t.to,to:t.from}}applyTransition(t,o,n,i,s,r){return new Promise((a=>{this.options.debug&&console.log(`Applying ${r} transition`);const l=this.createKeyframes(o,r),c=`${l} ${n}ms ${s} ${i}ms forwards`;t.style.setProperty("animation",c),this.options.debug&&console.log(`Applied ${r} animation: ${c}`),this.options.debug&&console.log("Current element style:",t.style.cssText),t.offsetWidth;t.addEventListener("animationend",(()=>{this.options.debug&&console.log(`Animation end event fired for ${r} transition`),t.style.removeProperty("animation"),this.removeKeyframes(l),"in"===r&&Object.entries(o.to||{}).forEach((([o,n])=>{t.style.setProperty(e(o),n)})),this.options.debug&&console.log(`Cleaned up ${r} animation`),this.options.debug&&console.log("Current element style after cleanup:",t.style.cssText),a()}),{once:!0})}))}setTransitionState(t,e){this.animationState[t]=e}runCallback(t){var e,o;const n=null===(o=null===(e=this.options.transition)||void 0===e?void 0:e.callback)||void 0===o?void 0:o[t];n&&"function"==typeof n&&n()}startTransition(){this.setTransitionState("started",!0),this.setTransitionState("playing",!0),this.setTransitionState("paused",!1),this.setTransitionState("finished",!1),this.runCallback("onStart"),this.runCallback("onPlay")}pauseTransition(){var t;if(this.animationState.playing){this.setTransitionState("playing",!1),this.setTransitionState("paused",!0),this.runCallback("onPause");const e=document.querySelector((null===(t=this.options.transition)||void 0===t?void 0:t.swapHtml)||"body");e instanceof HTMLElement&&(e.style.animationPlayState="paused")}}resumeTransition(){var t;if(this.animationState.paused){this.setTransitionState("playing",!0),this.setTransitionState("paused",!1),this.runCallback("onPlay");const e=document.querySelector((null===(t=this.options.transition)||void 0===t?void 0:t.swapHtml)||"body");e instanceof HTMLElement&&(e.style.animationPlayState="running")}}finishTransition(){this.setTransitionState("playing",!1),this.setTransitionState("paused",!1),this.setTransitionState("finished",!0),this.runCallback("onFinish")}}return function(t={}){return new i(t)}}));
//# sourceMappingURL=xref.umd.min.js.map
